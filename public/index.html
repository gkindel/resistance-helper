<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w"
  crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css">
<style>
  body {
    font-family: Georgia, Times, "Times New Roman", serif;
    font-size: 18px;
  }

  #newGame, #start {
    /* position: absolute;
    bottom: 0; */
    margin: 20px 0;
  }

  .spy {
    text-align: center;
    background: #c94c4c;
    color: white;
    font-weight: bold;
    padding: 20px 0;
  }

  .resistance {
    text-align: center;
    background: #034f84;
    color: white;
    padding: 20px 0;
    font-weight: bold;
  }

  .first {
    padding: 20px 0;
    background: #deeaee;
    text-align: center;
  }

  .player-count {
    padding: 20px 0;
    background: #deeaee;
    text-align: center;
  }

  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #other_spies {
    text-align: center;
    padding:10px 0;
  }

  li {
    padding: 6px 10px;
  }

  .game-type{
    text-align: center;
    margin-top:10px;
  }
  .game-type button{
    width:80%;

            border-radius: 4px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }
        .button-success {
          color: white;

            background: rgb(28, 184, 65); /* this is a green */
        }
        .button-secondary {
          color: white;

            background: rgb(66, 184, 221); /* this is a light blue */
        }
</style>

<body>
  <div id="lobby" class="pure-g">
    <div class="pure-u-1 pure-u-md-1-1">
      <form class="pure-form" onsubmit="return false;">
        <button id="join" class="pure-button pure-input-1">Join Game</button>
      </form>
    </div>
  </div>

  <!-- GAME -->
  <div id="game" class="pure-g">
    <div class="pure-u-1 pure-u-md-1-1 player-count">
      <strong id="playerCount">0</strong> players
    </div>
    <div class="pure-u-1 pure-u-md-1-1">
      <ul id="playerList"></ul>
    </div>
    <div class="pure-u-1">
      <div class="pure-g game-type">
          <div class="pure-u-1-2">
              <button class="pure-button button-large game-option" id="game-normal">Normal</button>
          </div>
          <div class="pure-u-1-2">
              <button class="pure-button button-large game-option" id="game-reverser">Reverser</button>
          </div>
      </div>
      <div class="pure-g game-type">
          <div class="pure-u-1-2">
              <button class="pure-button button-large game-option" id="game-hunter">Hunter</button>
          </div>
          <div class="pure-u-1-2">
              <button class="pure-button button-large game-option" id="game-defector">Defector</button>
          </div>
      </div>
      <div class="pure-g game-type">
          <div class="pure-u-1-2">
              <button class="pure-button button-large game-option" id="game-trapper">Trapper</button>
          </div>
          <div class="pure-u-1-2">
              <button class="pure-button button-large game-option" id="game-inquisitor">Inquisitor</button>
          </div>
      </div>
    </div>
    <div class="pure-u-1 pure-u-md-1-1">
      <form class="pure-form" onsubmit="return false;">
        <button class="pure-button pure-input-1" id="start">Start Game</button>
      </form>
    </div>
  </div>

  <!-- Result -->
  <div id="results" class="pure-g">
    <div class="pure-u-1 pure-u-md-1-1" id="team">
      TEAM
    </div>
    <div class="pure-u-1 pure-u-md-1-1" id="other_spies">
      <strong>Other Spies</strong>
      <ul class="pure-u-1" id="other_spies_list">
      </ul>
    </div>
    <hr />
    <div class="pure-u-1 first">
      <strong id="first_player"> x </strong> goes first
    </div>
    <div class="pure-u-1 pure-u-md-1-1">
      <form class="pure-form" onsubmit="return false;">
        <button class="pure-button pure-input-1" id="newGame">Reset Game</button>
      </form>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-messaging.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-functions.js"></script>
  <script>
    var MIN_PLAYERS = 2;

    var players = [];
    var selectedGameTypePrimary = '';
    var selectedGameTypeSecondary = '';

    var config = {
      apiKey: "AIzaSyALThai8CYhmSG91fsN499Kl-Mf1vP-_pY",
      authDomain: "resistance-1ec7a.firebaseapp.com",
      databaseURL: "https://resistance-1ec7a.firebaseio.com",
      projectId: "resistance-1ec7a",
      storageBucket: "resistance-1ec7a.appspot.com",
      messagingSenderId: "383282710233"
    };
    firebase.initializeApp(config);

    var provider = new firebase.auth.TwitterAuthProvider();

    firebase.auth().getRedirectResult().then(function (result) {
      if (result.credential) {
        var token = result.credential.accessToken;
        var secret = result.credential.secret;
      }
    }).catch(function (error) {
      var errorMessage = error.message;
      console.log(" TWITTER ERROR: " + errorMessage);
    });

    firebase.auth().onAuthStateChanged(function (user) {
      if (user) {
        var name = user.displayName;
        userRef = firebase.database().ref("presense/" + user.uid);
        userRef.update({
          name: name,
          uid: firebase.auth().currentUser.uid
        });

        $('#game').show();
        $('#lobby').hide();
      } else {
        // No user is signed in.
        $('#game').hide();
      }
    });

    var listRef = firebase.database().ref("presense");
    var stateRef = firebase.database().ref("state");
    var gameTypeRef = firebase.database().ref("game_type");

    var userRef = null;

    var presenceRef = firebase.database().ref(".info/connected");
    presenceRef.on("value", function (snap) {
      if (snap.val() && userRef) {
        // Remove ourselves when we disconnect.
        userRef.onDisconnect().remove();
        console.log("CONNECTED");
      } else {
        console.log("NOT CONNECTED");
        $('#lobby').show();
      }
    });

    stateRef.on("value", function (snap) {
      if (snap.val()) {
        $('#results').show();

        $('#game').hide();
        $('#lobby').hide();

        var myuid = firebase.auth().currentUser.uid;

        var spies = snap.val().spies;
        var resistance = snap.val().resistance;

        // Check these are valid.

        var amSpy = false;
        var otherSpies = [];

        for (var n in spies) {
          if (spies[n].uid === myuid) {
            amSpy = true;
          } else {
            otherSpies.push(spies[n]);
          }
        }

        $('#first_player').html(snap.val().first.name);

        /* Show other spies to spies */
        if (amSpy) {
          $('#team').html("SPY").removeClass('resistance').addClass('spy');
          $('#other_spies_list').empty()
          $('#other_spies').show();
          for (var x in otherSpies) {
            $('#other_spies_list').append('<li>' + otherSpies[x].name + '</li>');
          }
        } else {
          $('#team').html("RESISTANCE").removeClass('spy').addClass('resistance');
          $('#other_spies').hide();
        }
      } else {
        // There is no game state.
        $('#results').hide();
        $('#game').show();

        if (players.length >= MIN_PLAYERS) {
          $('#start').prop("disabled", false);
        } else {
          $('#start').prop("disabled", true);
        }
      }
    });

    listRef.on("value", function (snap) {
      var playerCount = snap.numChildren();

      $('#playerList').empty();

      players = [];
      snap.forEach(child => {
        players.push(child.val());
        $('#playerList').append('<li>' + child.val().name + '</li>');
      });

      $('#playerCount').html(playerCount);

      if (playerCount >= MIN_PLAYERS) {
        $('#start').prop("disabled", false);
      } else {
        $('#start').prop("disabled", true);
      }

    });

    $(function () {
      $('#results').hide();

      $('#newGame').click(function () {
        console.log("newGame");
        stateRef.remove();
      });

      $('#start').click(function () {
        startGame();
      });

      $('#join').click(function () {
        firebase.auth().signInWithRedirect(provider);
      });

      $('.game-option').click(function(event) {
        selectGameType(event.target.id);
      });

      selectGameType('game-normal');
      //selectGameType('game-reverser');

    });

    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex;
      while (0 !== currentIndex) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    }

    function selectGameType(button_id){
      console.log(button_id);

      // If it's primary, ignore
      // if it's secondary, make primary
      // If it's not, make it secondary
      if (button_id === selectedGameTypePrimary){
        // Swap
        var tmp = selectedGameTypeSecondary;
        selectedGameTypeSecondary = selectedGameTypePrimary;
        selectedGameTypeSecondary = tmp;
      }else if (button_id === selectedGameTypeSecondary){
        // Swap
        var tmp = selectedGameTypePrimary;
        selectedGameTypePrimary = selectedGameTypeSecondary;
        selectedGameTypeSecondary = tmp;
      }else{
        if (selectedGameTypePrimary === "")  selectedGameTypePrimary = button_id;
        else  selectedGameTypeSecondary = button_id;
      }

      $('.game-option').removeClass('button-secondary').removeClass('button-success');
      if (selectedGameTypePrimary !== "") $('#' + selectedGameTypePrimary).addClass('button-success');
      if (selectedGameTypeSecondary !== "") $('#' + selectedGameTypeSecondary).addClass('button-secondary');
      console.log(selectedGameTypePrimary);
      console.log(selectedGameTypeSecondary);
    }

    /*
      Choose the teams.
      Choose who goes first
    */
    function startGame() {
      var good = 0;
      var bad = 2;
      var total = players.length;

      if (total >= 7) {
        bad = 3;
        if (total >= 10){
          bad = 4;
        }
      }

      good = total - bad;

      console.log("Starting the game with " + bad + " spies, " + good + " good.");
      console.log(players);
      var playersShuffled = shuffle(players);

      var spies = [];
      var resistance = [];
      for (var x = 0; x < total; x++) {
        if (spies.length < bad) {
          spies.push(playersShuffled[x]);
        } else {
          resistance.push(playersShuffled[x]);
        }
      }

      /* Who goes first? */
      playersShuffled = shuffle(players);
      var firstPlayer = playersShuffled[0];
      console.log(firstPlayer + " goes first");

      stateRef.set({
        spies: spies,
        resistance: resistance,
        first: firstPlayer
      })

      $('#start').prop("disabled", true);
    }

  </script>
</body>

</html>